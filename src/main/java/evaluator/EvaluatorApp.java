/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package evaluator;

import jess.Userfunction;
import okhttp3.OkHttpClient;
import seakers.orekit.util.OrekitConfig;
import vassar.GlobalScope;
import vassar.VassarClient;
import vassar.combinatorics.Combinatorics;
import vassar.combinatorics.NDSM;
import vassar.combinatorics.Nto1pair;
import vassar.database.DatabaseClient;
import vassar.database.service.DebugAPI;
import vassar.database.service.QueryAPI;
import vassar.jess.Resource;
import vassar.jess.Requests;
import vassar.jess.func.Improve;
import vassar.jess.func.SameOrBetter;
import vassar.jess.func.Worsen;
import sqs.Consumer;
import software.amazon.awssdk.services.ecs.EcsClient;
import software.amazon.awssdk.services.sqs.SqsClient;
import software.amazon.awssdk.services.sqs.SqsClientBuilder;
import software.amazon.awssdk.regions.Region;

import java.net.URI;
import java.util.*;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.TimeUnit;
import java.util.logging.ConsoleHandler;
import java.util.logging.Level;
import java.util.logging.Logger;

public class EvaluatorApp {

    public static void main(String[] args) {

        // EvaluatorApp.testingFunc();

//  _____ _   _ _____ _______
// |_   _| \ | |_   _|__   __|
//   | | |  \| | | |    | |
//   | | | . ` | | |    | |
//  _| |_| |\  |_| |_   | |
// |_____|_| \_|_____|  |_|
//
        String coverageDatabase = ResourcePaths.resourcesRootDir + "/orekit/CoverageDatabase";
        String orekitInit       = ResourcePaths.resourcesRootDir + "/orekit";

        System.setProperty("orekit.coveragedatabase", coverageDatabase);
        OrekitConfig.init(1, orekitInit);

        GlobalScope.measurementsToSubobjectives = new HashMap<>();
        GlobalScope.subobjectivesToMeasurements = new HashMap<>();

        String outputFilePath     = ResourcePaths.rootDirectory + "/debug/dbOutput.json";
        String outputPath         = ResourcePaths.rootDirectory + "/debug";

        String region             = System.getenv("REGION");
        String requestQueueUrl    = System.getenv("EVAL_REQUEST_URL");
        String responseQueueUrl   = System.getenv("EVAL_RESPONSE_URL");
        String apolloUrl          = System.getenv("APOLLO_URL");
        String apolloWsUrl        = System.getenv("APOLLO_URL_WS");

        boolean debug = true;

        ArrayList<Userfunction> userFuncs = new ArrayList<>() {{
            add( new SameOrBetter() );
            add( new Improve() );
            add( new Worsen() );
        }};

        // -----> JESS REQUESTS
        String jessGlobalTempPath = ResourcePaths.resourcesRootDir + "/vassar/templates";
        String jessGlobalFuncPath = ResourcePaths.resourcesRootDir + "/vassar/functions";
        String jessAppPath        = ResourcePaths.resourcesRootDir + "/vassar/problems/SMAP/clp";
        String requestMode        = System.getenv("REQUEST_MODE");

        Requests requests = new Requests.Builder()
                                        .setGlobalTemplatePath(jessGlobalTempPath)
                                        .setGlobalFunctionPath(jessGlobalFuncPath)
                                        .setFunctionTemplates()
                                        .setRequestMode(requestMode)
                                        .setJessAppPath(jessAppPath)
                                        .build();


        // -----> When scaling, private queue names will be random
        ConcurrentLinkedQueue<Map<String, String>> queue = new ConcurrentLinkedQueue<>();

        System.out.println("\n------------------ VASSAR INIT ------------------");
        System.out.println("--------------> APOLLO URL: " + apolloUrl);
        System.out.println("------> EVAL REQUEST QUEUE: " + requestQueueUrl);
        System.out.println("-----> EVAL RESPONSE QUEUE: " + responseQueueUrl);
        System.out.println("------> PING REQUEST QUEUE: " + System.getenv("PING_REQUEST_URL"));
        System.out.println("-----> PING RESPONSE QUEUE: " + System.getenv("PING_RESPONSE_URL"));
        System.out.println("------> PRIV REQUEST QUEUE: " + System.getenv("PRIVATE_REQUEST_URL"));
        System.out.println("-----> PRIV RESPONSE QUEUE: " + System.getenv("PRIVATE_RESPONSE_URL"));
        System.out.println("------------> REQUEST MODE: " + requestMode);
        System.out.println("--------> DEVELOPMENT TYPE: " + System.getenv("DEPLOYMENT_TYPE"));
        System.out.println("-------------------------------------------------------\n");

//  _           _ _     _
// | |         (_) |   | |
// | |__  _   _ _| | __| |
// | '_ \| | | | | |/ _` |
// | |_) | |_| | | | (_| |
// |_.__/ \__,_|_|_|\__,_|
//
        
        // --> SQS Client
        SqsClientBuilder sqsClientBuilder = SqsClient.builder().region(Region.US_EAST_2);
        if (System.getenv("AWS_STACK_ENDPOINT") != null) {
            sqsClientBuilder.endpointOverride(URI.create(System.getenv("AWS_STACK_ENDPOINT")));
            sqsClientBuilder.region(Region.US_WEST_2);
        }
        final SqsClient sqsClient = sqsClientBuilder.build();

        // --> ECS Client
        EcsClient ecsClient = null;
        if (System.getenv("DEPLOYMENT_TYPE").equals("AWS")) {
            ecsClient = EcsClient.builder()
                            .region(Region.US_EAST_2)
                            .build();
        }

        // --> APIs
        QueryAPI queryAPI = new QueryAPI.Builder(apolloUrl, apolloWsUrl)
                                        .privateQueue(queue)
                                        .sqsClient(sqsClient)
                                        .build();

        DebugAPI debugAPI = new DebugAPI.Builder(outputFilePath)
                                        .setOutputPath(outputPath)
                                        .newFile()
                                        .build();

        DatabaseClient dbClient = new DatabaseClient.Builder()
                                        .debug(debug)
                                        .queryClient(queryAPI)
                                        .debugClient(debugAPI)
                                        .subscribe()
                                        .build();

        Resource engine = new Resource.Builder(dbClient)
                                        .addUserFunctionBatch(userFuncs)      // - Improve(), SameOrBetter(), Worsen()
                                        .setRequests(requests.getRequests())  // - eval: template requests (+ functions)
                                        .setRequestMode(requestMode)
                                        .build();

        VassarClient vClient = new VassarClient.Builder()
                                        .setEngine(engine)
                                        .build();
        


        Consumer evaluator = new Consumer.Builder(sqsClient)
                                         .setVassarClient(vClient)
                                         .setRequestQueueUrl(requestQueueUrl)
                                         .setResponseQueueUrl(responseQueueUrl)
                                         .setPrivateQueue(queue)
                                         .setECSClient(ecsClient)
                                         .debug(debug)
                                         .build();// RUN CONSUMER
        try {
            evaluator.run();
        }
        catch (Exception e) {
            e.printStackTrace();
        }
        finally {
            sqsClient.close();
            queryAPI.cancelAllSubscriptions();
            if (ecsClient != null) {
                ecsClient.close();
            }
            OrekitConfig.end();
            System.exit(0);
        }
    }

    // ---> SLEEP
    public static void sleep(int seconds){
        try                            { TimeUnit.SECONDS.sleep(seconds); }
        catch (InterruptedException e) { e.printStackTrace(); }
    }


    public static void testingFunc(){
        System.out.println("--> TESTING");

        String ndsm_filepath = "/app/output/DSM-TESTING2-2022-12-02-21-57-12.dat";
        ndsm_filepath = ResourcePaths.ndsm2_Decadal;

        HashMap<String, NDSM> ndsm = Combinatorics.getNDSMs(ndsm_filepath);
        for(String key: ndsm.keySet()){
            System.out.println(key);
        }

        TreeMap<Nto1pair,Double> sdsm = Combinatorics.combineNDSM_File(ndsm_filepath, "SDSM");
        TreeMap<Nto1pair,Double> edsm = Combinatorics.combineNDSM_File(ndsm_filepath, "EDSM");


        Iterator sdsm_iterator = sdsm.entrySet().iterator();
        while(sdsm_iterator.hasNext()){
            Map.Entry pair = (Map.Entry) sdsm_iterator.next();
            Object synergy_key = pair.getKey();
            Nto1pair nt = (Nto1pair) synergy_key;
            String has_synergy_with = nt.getBase()[0];
            String inst_check_synergy = nt.getAdded();
            System.out.println("--> INTERACTION: " + has_synergy_with + " " + inst_check_synergy);
        }




        System.exit(0);
    }
}
