########################
### Build Containers ###
########################

# Download and install dependencies not available on maven
FROM maven:3-jdk-11-slim AS BUILD_TOOL
WORKDIR /repos
RUN apt-get update -y
RUN apt-get upgrade -y
RUN apt-get install git -y
RUN git clone https://github.com/seakers/SystemArchitectureProblems.git
RUN git clone https://github.com/seakers/orekit.git

## 1. SystemArchitectureProblems ##
WORKDIR /repos/SystemArchitectureProblems
RUN git fetch && git checkout jdk-11
RUN mvn install

## 2. Orekit ##
WORKDIR /repos/orekit
RUN git checkout fov_changes
WORKDIR /repos/orekit/orekit
RUN mvn install

## 3. JESS ##
WORKDIR /repos/jars
COPY /design-evaluator/jars/jess.jar /repos/jars/jess.jar
RUN mvn install:install-file -Dfile=./jess.jar -DgroupId=gov.sandia -DartifactId=jess -Dversion=7.1p2 -Dpackaging=jar


## 4. INSTALL APP ##
WORKDIR /resources
COPY /VASSAR_resources/. /resources/.
WORKDIR /app
COPY /design-evaluator/. /app/.

RUN ./gradlew installDist





#######################
### Final Container ###
#######################
FROM amazoncorretto:11

WORKDIR /app
COPY /design-evaluator/. /app/.

WORKDIR /resources
COPY /VASSAR_resources/. /resources/.

COPY --from=BUILD_TOOL /app/build/install/evaluator /app/evaluator

WORKDIR /app/evaluator
CMD ./bin/evaluator

